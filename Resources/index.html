<html>
<head>
<title>VeloRoutenPlaner</title>
<script src="https://apis.google.com/js/client.js?onload=load"></script>
<meta property="og:image" content="http://familientagebuch.de/rainer/img/2012/verupla1.png" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&language=de"></script>

<meta property="og:title" content="VeloRoutenPlaner | appWerft" />
<meta property="og:description" content="VeloRoutenPlaner: spielend leichte Übertragung von Routen aus dem Web per QR auf das Smartphone | appWerft" />

<style>
* {font-family:Arial;font-size:8pt;color:#333}
body {margin:0;padding:0}
#qr {position:absolute;right:0;top:0}
</style>
<script type="text/javascript">
if ((navigator.userAgent.match(/iPhone/i))||(navigator.userAgent.match(/iPad/i))) {
    document.location = 'veloroutenplaner://';
    setTimeout(function(){
        if(((new Date()).getTime()-(new Date()).getTime())<400) {
            if(confirm('Sie haben die Veloplaner noch nicht installiert, möchten Sie das jetzt tun?')){
                document.location = 'http://itunes.apple.com/de/app/veloroutenplaner/id546625444';
            }
        }
    }, 300);
}

function createEncodings(coords) {
	var i = 0;
 
	var plat = 0;
	var plng = 0;
 
	var encoded_points = "";
 
	for(i = 0; i < coords.length; ++i) {
	    var lat = coords[i][0];				
		var lng = coords[i][1];		
 
		encoded_points += encodePoint(plat, plng, lat, lng);
 
	    plat = lat;
	    plng = lng;
	}
 
	// close polyline
	encoded_points += encodePoint(plat, plng, coords[0][0], coords[0][1]);
 
	return encoded_points;
}
 
function encodePoint(plat, plng, lat, lng) {
	var late5 = Math.round(lat * 1e5);
    var plate5 = Math.round(plat * 1e5)    
 
	var lnge5 = Math.round(lng * 1e5);
    var plnge5 = Math.round(plng * 1e5)
 
	dlng = lnge5 - plnge5;
	dlat = late5 - plate5;
 
    return encodeSignedNumber(dlat) + encodeSignedNumber(dlng);
}
 
function encodeSignedNumber(num) {
  var sgn_num = num << 1;
 
  if (num < 0) {
    sgn_num = ~(sgn_num);
  }
 
  return(encodeNumber(sgn_num));
}
 
function encodeNumber(num) {
  var encodeString = "";
 
  while (num >= 0x20) {
    encodeString += (String.fromCharCode((0x20 | (num & 0x1f)) + 63));
    num >>= 5;
  }
 
  encodeString += (String.fromCharCode(num + 63));
  return encodeString;
}


  var geoip = {};
    function getGeoIP(data) {
    geoip=data;
  }	

  var directionsDisplay;
  var directionsService = new google.maps.DirectionsService();
  var map;
  var oldDirections = [];
  var currentDirections = null;
  var osmMapType = new google.maps.ImageMapType({
	getTileUrl: function(coord, zoom) {
		return "http://tile.openstreetmap.org/" +
		zoom + "/" + coord.x + "/" + coord.y + ".png";
	},
	tileSize: new google.maps.Size(256, 256),
	isPng: true,
	alt: "OpenStreetMap layer",
	name: "OpenStreetMap",
	maxZoom: 19
});
  function initialize() {
    var myOptions = {
      zoom: 13,
        mapTypeId: 'OSM',
        disableDefaultUI: true,
				zoomControl: true,
	   			language : '',
	   			zoomControlOptions: {
        		style: google.maps.ZoomControlStyle.SMALL
            },
      center: new google.maps.LatLng(geoip.latitude,geoip.longitude)
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.mapTypes.set('OSM',osmMapType);
	map.setMapTypeId('OSM');
	directionsDisplay = new google.maps.DirectionsRenderer({
        'map': map,
        'preserveViewport': false,
        'polylineOptions' : {strikeColor:'#cc0000'},
	 //   'markerOptions' : {icon:'http://webmasterei.com/fileadmin/templates/img/wmalfa.png'},
        'suppressInfoWindows': true,
        'draggable': true,
         'suppressMarkers': false,
         'hideRouteList' : true
    });
    directionsDisplay.setPanel(document.getElementById("directions_panel"));

    google.maps.event.addListener(directionsDisplay, 'directions_changed',
      function() {
        if (currentDirections) {
          oldDirections.push(currentDirections);
          setUndoDisabled(false);
        }
        currentDirections = directionsDisplay.getDirections();
		var polyline = [];
		 var leg = currentDirections.routes[0].legs[0];
        polyline.push([leg.start_location.lat(),leg.start_location.lng()]);
        
         for (var i=0;i<leg.via_waypoints.length;i++) {
         try{
	        polyline.push([leg.via_waypoints[i].lat(),leg.via_waypoints[i].lng()]);
        } catch(E) {}
        }  
        polyline.push([leg.end_location.lat(),leg.end_location.lng()]);
        var encoded =  createEncodings(polyline)
         self.location = 'http://r.webmasterei.com/#' +encoded;
        document.getElementById('qr').innerHTML='<img src="http://qr.kaywa.com/?s=4&d=http%3A%2F%2Fr.webmasterei.com%2F%3F'+encoded + '">';
      });

    setUndoDisabled(true);

    calcRoute();
  }

  function calcRoute() {
    var start = geoip.latitude + ', ' + geoip.longitude;
    var end = 'Hamburg Novalisweg 10';
    var request = {
        origin:start,
        destination:end,
        language : 'de',
        travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
      			map.fitBounds(response.routes[0].bounds);
         	//	console.log(response.routes[0].overview_polyline.points);
          		
       directionsDisplay.setDirections(response);
      }
    });
  }

  function undo() {
    currentDirections = null;
    directionsDisplay.setDirections(oldDirections.pop());
    if (!oldDirections.length) {
      setUndoDisabled(true);
    }
  }

  function setUndoDisabled(value) {
    document.getElementById("undo").disabled = value;
  }
  



</script>
<script type="text/javascript" src="http://tools.webmasterei.com/geoip/json.php?callback=getGeoIP"></script>
</head>
<body onload="initialize()">
<div id="map_canvas" style="float:left;width:100%;height:100%"></div>
<div id="qr"></div>
<div style="float:right;width:0%;height:100%;overflow:auto">
  
  <div id="directions_panel" style="width:100%"></div>
<button id="undo" style="display:block;margin:auto" onclick="undo()">Undo
  </button>
</div>

</body>
</html>
